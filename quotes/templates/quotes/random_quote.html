<!-- quotes/random_quote.html -->
<!DOCTYPE html>
<html>
<head>
    <title>–°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞</title>
    <style>
        .rated { 
            opacity: 0.6; 
            cursor: not-allowed;
        }
        .not-rated { 
            cursor: pointer; 
        }
        .not-rated:hover { 
            opacity: 0.8; 
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        #like-btn.rated { background-color: #4CAF50; color: white; }
        #dislike-btn.rated { background-color: #f44336; color: white; }
        #like-btn.not-rated { background-color: #e8f5e8; }
        #dislike-btn.not-rated { background-color: #ffebee; }
        #next-btn { 
            background-color: #2196F3; 
            color: white; 
            margin-top: 15px;
            padding: 12px 20px;
        }
        #next-btn:hover { background-color: #1976D2; }
        .quote-container {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #2196F3;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>–°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞</h1>
    
    <div id="quote-container">
        {% if quote %}
            <div class="quote-container">
                <blockquote>
                    "<span id="quote-text">{{ quote.text }}</span>"
                    <footer>- <span id="quote-source">{{ quote.source }}</span></footer>
                </blockquote>
                
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: <span id="views">{{ quote.views }}</span></p>
                
                <button id="like-btn" 
                        class="{% if user_has_liked %}rated{% else %}not-rated{% endif %}"
                        onclick="rateQuote('like', {{ quote.id }})"
                        {% if user_has_liked %}disabled{% endif %}>
                    üëç <span id="likes">{{ quote.likes }}</span>
                </button>
                
                <button id="dislike-btn" 
                        class="{% if user_has_disliked %}rated{% else %}not-rated{% endif %}"
                        onclick="rateQuote('dislike', {{ quote.id }})"
                        {% if user_has_disliked %}disabled{% endif %}>
                    üëé <span id="dislikes">{{ quote.dislikes }}</span>
                </button>
            </div>
        {% else %}
            <p>–¶–∏—Ç–∞—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. <a href="{% url 'add_quote' %}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–∏—Ç–∞—Ç—É!</a></p>
        {% endif %}
    </div>
    
    {% if quote %}
        <button id="next-btn" onclick="getNextQuote()">–°–ª–µ–¥—É—é—â–∞—è —Ü–∏—Ç–∞—Ç–∞ ‚Üí</button>
    {% endif %}
    
    <br><br>
    <a href="{% url 'add_quote' %}">–î–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ç–∞—Ç—É</a> | 
    <a href="{% url 'popular_quotes' %}">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã</a>
    
    <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function rateQuote(action, quoteId) {
        fetch(`/${action}/${quoteId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('likes').textContent = data.likes;
                document.getElementById('dislikes').textContent = data.dislikes;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
                if (action === 'like') {
                    document.getElementById('like-btn').classList.add('rated');
                    document.getElementById('like-btn').classList.remove('not-rated');
                    document.getElementById('like-btn').disabled = true;
                    
                    document.getElementById('dislike-btn').classList.remove('rated');
                    document.getElementById('dislike-btn').classList.add('not-rated');
                    document.getElementById('dislike-btn').disabled = false;
                } else {
                    document.getElementById('dislike-btn').classList.add('rated');
                    document.getElementById('dislike-btn').classList.remove('not-rated');
                    document.getElementById('dislike-btn').disabled = true;
                    
                    document.getElementById('like-btn').classList.remove('rated');
                    document.getElementById('like-btn').classList.add('not-rated');
                    document.getElementById('like-btn').disabled = false;
                }
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ —Ü–∏—Ç–∞—Ç—ã');
        });
    }

    function getNextQuote() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const nextBtn = document.getElementById('next-btn');
        const originalText = nextBtn.textContent;
        nextBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        nextBtn.disabled = true;

        fetch('/next/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                document.getElementById('quote-text').textContent = data.quote_text;
                document.getElementById('quote-source').textContent = data.quote_source;
                document.getElementById('views').textContent = data.views;
                document.getElementById('likes').textContent = data.likes;
                document.getElementById('dislikes').textContent = data.dislikes;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫–æ–≤
                const likeBtn = document.getElementById('like-btn');
                const dislikeBtn = document.getElementById('dislike-btn');

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å –Ω–æ–≤—ã–º ID —Ü–∏—Ç–∞—Ç—ã
                likeBtn.onclick = function() { rateQuote('like', data.quote_id); };
                dislikeBtn.onclick = function() { rateQuote('dislike', data.quote_id); };

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
                if (data.user_has_liked) {
                    likeBtn.classList.add('rated');
                    likeBtn.classList.remove('not-rated');
                    likeBtn.disabled = true;
                } else {
                    likeBtn.classList.remove('rated');
                    likeBtn.classList.add('not-rated');
                    likeBtn.disabled = false;
                }

                if (data.user_has_disliked) {
                    dislikeBtn.classList.add('rated');
                    dislikeBtn.classList.remove('not-rated');
                    dislikeBtn.disabled = true;
                } else {
                    dislikeBtn.classList.remove('rated');
                    dislikeBtn.classList.add('not-rated');
                    dislikeBtn.disabled = false;
                }
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ü–∏—Ç–∞—Ç—ã');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            nextBtn.textContent = originalText;
            nextBtn.disabled = false;
        });
    }
    </script>
</body>
</html>